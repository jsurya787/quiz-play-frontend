<div class="chapter-page-root relative min-h-screen w-full bg-[#fcfcfd] pt-20 pb-12 overflow-x-clip">
  
  <!-- PREMIUM BACKGROUND DECOR -->
  <div class="bg-decor bg-decor-1 opacity-20"></div>
  <div class="bg-decor bg-decor-2 opacity-20"></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    <div class="grid lg:grid-cols-4 gap-8">

      <!-- ================= SIDEBAR ================= -->
      <aside class="hidden lg:block">
        <div class="sidebar-glass p-5 sticky top-28 transition-all duration-500 animate-fade-in-up">
          @if (loading()) {
            <div class="space-y-4">
              <div class="skeleton-box h-5 w-40 rounded-lg"></div>
              <div class="space-y-2">
                @for (i of [1,2,3,4,5]; track i) {
                  <div class="skeleton-box h-4 w-full rounded-md"></div>
                }
              </div>
            </div>
          } @else {
            <div class="flex items-center gap-2 mb-4">
              <span class="text-xs font-black text-indigo-600 uppercase tracking-widest">Navigation</span>
              <div class="h-px flex-1 bg-gradient-to-r from-indigo-100 to-transparent"></div>
            </div>
            
            <h3 class="font-black text-gray-900 tracking-tight text-base mb-6 leading-tight">
              üìò {{ chapter()?.name }}
            </h3>

            <nav class="space-y-1">
              @for (sec of sections(); track sec._id) {
                <button
                  class="w-full text-left px-3 py-2 text-sm font-medium rounded-xl transition-all group flex items-center gap-2"
                  [ngClass]="activeSectionId() === sec._id 
                    ? 'text-indigo-600 bg-indigo-50 font-bold shadow-sm' 
                    : 'text-gray-500 hover:text-indigo-600 hover:bg-indigo-50/50'"
                  (click)="scrollTo(sec._id)">
                  <span class="w-1.5 h-1.5 rounded-full transition-all duration-300"
                        [ngClass]="activeSectionId() === sec._id 
                          ? 'bg-indigo-500 scale-125 shadow-[0_0_8px_rgba(79,70,229,0.5)]' 
                          : 'bg-gray-200 group-hover:bg-indigo-400'"></span>
                  <span class="truncate">{{ sec.title }}</span>
                </button>
              } @empty {
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-3">No sections yet</p>
              }
            </nav>
          }
        </div>
      </aside>

      <!-- ================= MAIN CONTENT ================= -->
      <main class="lg:col-span-3">

        <!-- CHAPTER HEADER -->
        <header class="hero-glass p-6 sm:p-8 mb-8 animate-fade-in-up">
          @if (loading()) {
            <div class="space-y-4">
              <div class="skeleton-box h-8 w-64 rounded-xl"></div>
              <div class="skeleton-box h-4 w-full max-w-xl rounded-lg"></div>
              <div class="skeleton-box h-4 w-96 rounded-lg"></div>
            </div>
          } @else {
            <div class="flex flex-col sm:flex-row justify-between items-start gap-6">
              <div class="max-w-2xl">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 bg-indigo-50 text-[10px] font-black uppercase tracking-widest text-indigo-600 rounded-md">Chapter Guide</span>
                  <div class="h-0.5 w-6 bg-indigo-100 rounded-full"></div>
                </div>
                
                <h1 class="text-3xl font-black text-gray-900 tracking-tight leading-tight">
                  {{ chapter()?.name }}
                </h1>
                
                <p class="mt-3 text-sm font-medium text-gray-500 leading-relaxed">
                  {{ chapter()?.description }}
                </p>
              </div>

              @if (isAdmin()) {
                <button
                  class="btn-primary w-full sm:w-auto px-6 py-2.5 text-xs italic shadow-xl shadow-indigo-100/50"
                  (click)="openAddSection()">
                  + Add Section
                </button>
              }
            </div>
          }
        </header>

        <!-- ================= SECTIONS LIST ================= -->
        <div class="space-y-8">
          @if (loading()) {
            @for (i of [1,2,3]; track i) {
              <div class="skeleton-box h-48 rounded-[24px]"></div>
            }
          } @else {
            @for (section of sections(); track section._id; let i = $index) {
              <section
                class="premium-card animate-fade-in-up group"
                [style.animation-delay]="(i * 80) + 'ms'"
                id="section-{{ section._id }}">

                <div class="flex justify-between items-start mb-4 relative z-10">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-sm"
                         [ngClass]="{
                           'bg-indigo-50 text-indigo-600': section.type === 'theory',
                           'bg-green-50 text-green-600': section.type === 'example',
                           'bg-amber-50 text-amber-600': section.type === 'formula',
                           'bg-slate-50 text-slate-600': section.type === 'note'
                         }">
                      @if (section.type === 'theory') { üìò }
                      @else if (section.type === 'example') { ‚úçÔ∏è }
                      @else if (section.type === 'formula') { üßÆ }
                      @else { üìù }
                    </div>
                    <h2 class="text-lg font-black text-gray-800 tracking-tight">
                      {{ section.title }}
                    </h2>
                  </div>

                  @if (isAdmin()) {
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button 
                        class="w-7 h-7 rounded-lg bg-white border border-black/[0.03] text-[10px] flex items-center justify-center hover:bg-indigo-50 hover:text-indigo-600 transition-all"
                        (click)="openEditSection(section)">‚úèÔ∏è</button>
                      <button 
                        class="w-7 h-7 rounded-lg bg-red-50 border border-red-100/50 text-red-500 text-[10px] flex items-center justify-center hover:bg-red-100 transition-all"
                        (click)="confirmDeleteSection(section._id)">üóë</button>
                    </div>
                  }
                </div>

                <div
                  class="relative z-10 pl-11 text-sm font-medium text-gray-600 leading-relaxed whitespace-pre-line border-l-2 ml-4"
                  [ngClass]="{
                    'border-indigo-200': section.type === 'theory',
                    'border-green-200': section.type === 'example',
                    'border-amber-200': section.type === 'formula',
                    'border-slate-200': section.type === 'note'
                  }">
                  {{ section.content }}
                </div>
              </section>
            } @empty {
              <div class="py-16 text-center opacity-20 border border-dashed border-gray-200 rounded-[32px]">
                <p class="text-4xl mb-3">üìñ</p>
                <p class="text-[10px] font-black uppercase tracking-widest text-gray-400">Section content arriving soon...</p>
              </div>
            }
          }
        </div>

      </main>
    </div>
  </div>
</div>

<!-- ================= MANAGEMENT POPUP ================= -->
@if (showPopup()) {
  <div class="fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-gray-900/30 backdrop-blur-[2px] animate-fade-in" (click)="closePopup()"></div>
    
    <div class="modal-glass w-full max-w-md relative z-10 animate-profile-pop p-8 lg:p-10">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-black text-gray-900 tracking-tight italic uppercase underline decoration-indigo-200 decoration-4 underline-offset-[-1px]">
          {{ popupTitle() }}
        </h2>
        <button class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-gray-900 transition-colors" (click)="closePopup()">‚úï</button>
      </div>

      <!-- DELETE CONFIRM -->
      @if (popupType() === 'confirmDelete') {
        <div class="text-center py-4">
          <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">‚ö†Ô∏è</div>
          <p class="text-base font-bold text-gray-700 leading-relaxed">Shall we proceed with this deletion?</p>
          <p class="text-[10px] text-gray-400 uppercase tracking-widest mt-1">This action cannot be undone</p>
        </div>
      }

      <!-- FORM FIELDS -->
      <div class="space-y-4">
        @if (popupType() === 'section') {
          <div class="space-y-1.5">
            <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest px-1">Section Title</label>
            <input class="input-premium py-2.5 text-sm" placeholder="Ex: Introduction to Neural Nets" [(ngModel)]="formModel().title">
          </div>

          <div class="space-y-1.5">
            <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest px-1">Content Type</label>
            <select class="input-premium py-2.5 text-sm" [(ngModel)]="formModel().type">
              <option value="theory">üìò Theory</option>
              <option value="example">‚úçÔ∏è Example</option>
              <option value="formula">üßÆ Formula</option>
              <option value="note">üìù Note</option>
            </select>
          </div>

          <div class="space-y-1.5">
            <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest px-1">Deep Content</label>
            <textarea rows="6" class="textarea-premium p-3 text-sm" placeholder="Detailed curriculum content..." [(ngModel)]="formModel().content"></textarea>
          </div>
        }
      </div>

      <!-- MODAL ACTIONS -->
      <div class="mt-10 flex flex-col sm:flex-row gap-3">
        <button class="flex-1 py-3 text-xs font-black uppercase tracking-tight text-gray-400 hover:text-gray-600 transition-colors" (click)="closePopup()">Abort</button>
        
        @if (popupType() === 'confirmDelete') {
          <button class="btn-primary flex-1 py-3 text-xs italic bg-red-600 from-red-600 to-red-700 shadow-lg shadow-red-100/50" (click)="performDelete()">Confirm Purge</button>
        } @else {
          <button class="btn-primary flex-1 py-3 text-xs italic shadow-xl shadow-indigo-100/50" (click)="saveForm()">
            {{ formModel()._id ? 'Update' : 'Initialize' }} Record
          </button>
        }
      </div>
    </div>
  </div>
}
