@if (loading()) {
  <div class="min-h-screen bg-[#F8FAFC]">
    <div class="max-w-4xl mx-auto px-6 py-12">
      <!-- Skeleton Header -->
      <div class="h-8 w-48 bg-gray-200 rounded-full mx-auto mb-12 animate-pulse"></div>
      
      <!-- Skeleton Score Card -->
      <div class="h-[400px] w-full bg-white border border-gray-100 rounded-[2.5rem] p-8 animate-pulse mb-8"></div>
      
      <!-- Skeleton Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="h-32 bg-white rounded-3xl animate-pulse"></div>
        <div class="h-32 bg-white rounded-3xl animate-pulse"></div>
        <div class="h-32 bg-white rounded-3xl animate-pulse"></div>
        <div class="h-32 bg-white rounded-3xl animate-pulse"></div>
      </div>
    </div>
  </div>
} @else {
  <div class="min-h-screen bg-gradient-to-br from-[#F8FAFC] via-white to-indigo-50/30 relative overflow-hidden font-sans pb-20">

    <!-- ================= CINEMATIC BACKGROUND EFFECTS ================= -->
    <div class="absolute inset-0 pointer-events-none z-0 overflow-hidden">
      <!-- Radiant Blobs -->
      <div class="absolute top-[-10%] left-[-10%] w-[800px] h-[800px] bg-indigo-300/10 rounded-full blur-[120px] animate-pulse"></div>
      <div class="absolute bottom-[-10%] right-[-10%] w-[800px] h-[800px] bg-emerald-300/10 rounded-full blur-[120px] animate-pulse" style="animation-delay: 1.5s;"></div>
      
      @if (percentage() >= 70) {
        <!-- Restored Cinematic Elements -->
        <div class="absolute left-1/2 bottom-10 -translate-x-1/2 rocket-launch">üöÄ</div>
        <div class="sparkle sparkle-1">‚ú®</div>
        <div class="sparkle sparkle-2">‚ú®</div>
        <div class="sparkle sparkle-3">‚ú®</div>
        <div class="sparkle sparkle-4">‚ú®</div>
      }
    </div>

    <!-- ================= STICKY HEADER ================= -->
    <header class="sticky top-0 z-50 h-20 flex items-center justify-between px-6 md:px-12 bg-white/70 backdrop-blur-xl border-b border-white/50 shadow-sm animate-header-drop">
      
      <!-- HOME BUTTON -->
      <div class="flex items-center gap-2 cursor-pointer group" (click)="goToHome()">
        <div class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center shadow-lg shadow-gray-100 group-hover:scale-105 group-hover:bg-indigo-50 group-hover:border-indigo-100 transition-all duration-300">
          <svg class="w-5 h-5 text-gray-500 group-hover:text-indigo-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        </div>
        <span class="hidden sm:block font-bold text-gray-400 group-hover:text-indigo-600 transition-colors text-sm uppercase tracking-wide">Home</span>
      </div>
      
      <!-- TITLE -->
      <div class="hidden md:flex flex-col items-center">
        <span class="font-black text-gray-800 tracking-tight text-lg">Quiz Result</span>
        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em]">{{ quizTitle() }}</span>
      </div>

      <!-- DASHBOARD BUTTON -->
      <div class="flex items-center gap-2 cursor-pointer group" (click)="goToDashboard()">
        <span class="hidden sm:block font-bold text-gray-400 group-hover:text-indigo-600 transition-colors text-sm uppercase tracking-wide">Dashboard</span>
        <div class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center shadow-lg shadow-gray-100 group-hover:scale-105 group-hover:bg-indigo-50 group-hover:border-indigo-100 transition-all duration-300">
          <svg class="w-5 h-5 text-gray-500 group-hover:text-indigo-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
        </div>
      </div>
    </header>

    <main class="relative z-10 max-w-5xl mx-auto px-4 sm:px-6 pt-10">

      <!-- ================= MAIN SCORE CARD ================= -->
      <div class="relative bg-white/70 backdrop-blur-2xl rounded-[3rem] p-8 md:p-12 shadow-[0_20px_50px_rgba(0,0,0,0.08)] border border-white/60 animate-slide-up ring-4 ring-white/40">
        
        <div class="flex flex-col md:flex-row items-center gap-12 md:gap-20">
          
          <!-- LEFT: CIRCULAR PROGRESS -->
          <div class="relative w-64 h-64 flex-shrink-0 animate-scale-in delay-200">
            <!-- Glow behind circle -->
            <div class="absolute inset-0 bg-indigo-400/20 blur-3xl rounded-full"></div>
            
            <!-- Background Circle -->
            <svg class="w-full h-full rotate-[-90deg] drop-shadow-xl" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="#F1F5F9" stroke-width="8" stroke-linecap="round"></circle>
              <!-- Progress Circle -->
              <circle cx="50" cy="50" r="45" fill="none" 
                      [attr.stroke]="getScoreColor(percentage())" 
                      stroke-width="8" 
                      stroke-linecap="round"
                      stroke-dasharray="283"
                      [attr.stroke-dashoffset]="283 - (283 * percentage()) / 100"
                      class="transition-all duration-[1.5s] ease-out"></circle>
            </svg>
            
            <!-- Inner Content -->
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span class="text-6xl font-black text-slate-800 tracking-tighter animate-fade-in delay-500 drop-shadow-sm">
                {{ percentage() }}<span class="text-3xl text-gray-400">%</span>
              </span>
              <span class="text-xs font-bold uppercase tracking-widest text-gray-400 mt-1">Score</span>
            </div>
          </div>

          <!-- RIGHT: TEXT CONTENT -->
          <div class="text-center md:text-left flex-1 space-y-5 animate-fade-in-right delay-300">
            <h2 class="text-4xl md:text-6xl font-black text-slate-900 tracking-tight leading-[1] drop-shadow-sm">
              @if (percentage() >= 90) { <span class="bg-gradient-to-r from-emerald-500 to-teal-500 bg-clip-text text-transparent">Legendary!</span> üèÜ }
              @else if (percentage() >= 70) { <span class="bg-gradient-to-r from-emerald-500 to-green-500 bg-clip-text text-transparent">Great Job!</span> üéâ }
              @else if (percentage() >= 50) { <span class="bg-gradient-to-r from-indigo-500 to-blue-500 bg-clip-text text-transparent">Good Effort!</span> üëç }
              @else { <span class="bg-gradient-to-r from-slate-600 to-indigo-600 bg-clip-text text-transparent">Keep Learning!</span> üìö }
            </h2>
            
            <p class="text-lg text-slate-500 font-medium max-w-md mx-auto md:mx-0 leading-relaxed">
              You crushed <strong class="text-indigo-600">{{ correct() }}</strong> out of <strong class="text-indigo-600">{{ questions().length }}</strong> questions.
              @if (percentage() >= 70) { <br>That was an outstanding performance! }
              @else { <br>Check your mistakes below to improve next time. }
            </p>

            <div class="pt-6 flex flex-wrap justify-center md:justify-start gap-4">
              <button class="px-8 py-4 rounded-2xl bg-gray-900 text-white font-bold shadow-xl shadow-gray-900/20 transition-all hover:bg-black hover:-translate-y-1 active:scale-95 text-sm uppercase tracking-wide" (click)="goToDashboard()">
                Continue Quiz
              </button>
              <button class="px-8 py-4 rounded-2xl bg-white text-gray-700 font-bold border border-gray-200 shadow-sm transition-all hover:bg-gray-50 hover:border-gray-300 hover:-translate-y-1 active:scale-95 text-sm uppercase tracking-wide" (click)="openReview()">
                Review Errors
              </button>
            </div>
          </div>

        </div>
      </div>

      <!-- ================= STATS GRID ================= -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mt-6 md:mt-10 animate-slide-up delay-400">
        
        <!-- CORRECT -->
        <div class="group bg-emerald-50/60 border border-emerald-100 hover:bg-emerald-100/50 hover:border-emerald-200 rounded-[2.5rem] p-6 flex flex-col items-center justify-center text-center transition-all duration-300 backdrop-blur-sm shadow-sm hover:shadow-md hover:-translate-y-1">
          <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl mb-4 transition-colors bg-white shadow-sm text-emerald-500">‚úì</div>
          <div class="text-4xl font-black mb-1 text-emerald-800">{{ correct() }}</div>
          <div class="text-[10px] font-bold uppercase tracking-[0.2em] text-emerald-600/60">Correct</div>
        </div>

        <!-- WRONG -->
        <div class="group bg-red-50/60 border border-red-100 hover:bg-red-100/50 hover:border-red-200 rounded-[2.5rem] p-6 flex flex-col items-center justify-center text-center transition-all duration-300 backdrop-blur-sm shadow-sm hover:shadow-md hover:-translate-y-1">
          <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl mb-4 transition-colors bg-white shadow-sm text-red-500">‚úï</div>
          <div class="text-4xl font-black mb-1 text-red-800">{{ wrong() }}</div>
          <div class="text-[10px] font-bold uppercase tracking-[0.2em] text-red-600/60">Mistakes</div>
        </div>

        <!-- SKIPPED -->
        <div class="group bg-slate-50/60 border border-slate-200 hover:bg-slate-100/50 hover:border-slate-300 rounded-[2.5rem] p-6 flex flex-col items-center justify-center text-center transition-all duration-300 backdrop-blur-sm shadow-sm hover:shadow-md hover:-translate-y-1">
          <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl mb-4 transition-colors bg-white shadow-sm text-slate-500">-</div>
          <div class="text-4xl font-black mb-1 text-slate-700">{{ skipped() }}</div>
          <div class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-500/60">Skipped</div>
        </div>

        <!-- ACCURACY -->
        <div class="group bg-indigo-50/60 border border-indigo-100 hover:bg-indigo-100/50 hover:border-indigo-200 rounded-[2.5rem] p-6 flex flex-col items-center justify-center text-center transition-all duration-300 backdrop-blur-sm shadow-sm hover:shadow-md hover:-translate-y-1">
          <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl mb-4 transition-colors bg-white shadow-sm text-indigo-500">üéØ</div>
          <div class="text-4xl font-black mb-1 text-indigo-800">{{ accuracy() }}%</div>
          <div class="text-[10px] font-bold uppercase tracking-[0.2em] text-indigo-600/60">Accuracy</div>
        </div>

      </div>

      <!-- ================= QUESTION MAP ================= -->
      <div class="mt-12 md:mt-16 mb-24 animate-slide-up delay-500">
          <div class="flex items-end justify-between mb-8 px-2">
            <div>
              <h3 class="text-2xl font-black text-slate-900 tracking-tight">Question Analysis</h3>
              <p class="text-sm text-gray-500 font-medium mt-1">Click on any number to see details</p>
            </div>
            <div class="hidden sm:flex items-center gap-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Correct</span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Wrong</span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> Skipped</span>
            </div>
          </div>

          <div class="p-8 bg-white/60 backdrop-blur-xl border border-white/60 shadow-[0_4px_30px_rgba(0,0,0,0.03)] rounded-[2.5rem]">
            <div class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-3 md:gap-4">
               @for (q of questions(); track q.questionId; let i = $index) {
                  <button 
                    class="opacity-0 animate-scale-in w-10 h-10 md:w-12 md:h-12 rounded-2xl flex items-center justify-center font-bold text-sm transition-all duration-300 transform hover:scale-110 shadow-sm border-2"
                    [style.animation-delay.ms]="i * 40"
                    [ngClass]="{
                      'bg-emerald-100 border-emerald-200 text-emerald-700 shadow-emerald-100 hover:shadow-emerald-200': q.status === 'correct',
                      'bg-red-100 border-red-200 text-red-600 shadow-red-100 hover:shadow-red-200': q.status === 'wrong',
                      'bg-white border-slate-200 text-slate-400 shadow-gray-100 hover:border-slate-300 hover:text-slate-600': q.status === 'skipped'
                    }"
                    (click)="openQuestionPopup(q, i)">
                    {{ i + 1 }}
                  </button>
               }
            </div>
          </div>
      </div>

    </main>
  </div>
}

<!-- ================= QUESTION POPUP ================= -->
@if (showQuestionPopup()) {
  <div class="fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" (click)="closeQuestionPopup()">
    <div class="bg-white w-full max-w-2xl rounded-[2.5rem] p-6 md:p-10 shadow-2xl animate-scale-in border border-gray-100" (click)="$event.stopPropagation()">
      
      <div class="flex justify-between items-start mb-8 border-b border-gray-100 pb-6">
        <div>
           <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md">Question {{ activeQuestionIndex()! + 1 }}</span>
           <h3 class="text-2xl font-black text-slate-900 mt-3">Review Answer</h3>
        </div>
        <button class="w-10 h-10 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:bg-gray-100 hover:text-gray-900 transition-colors" (click)="closeQuestionPopup()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

       <p class="text-xl font-medium text-slate-700 mb-8 leading-relaxed">
         {{ activeQuestion()?.question }}
       </p>

       <div class="space-y-3">
         @for (opt of activeQuestion()?.options; track $index; let idx = $index) {
            <div class="flex items-center gap-4 p-4 rounded-2xl border-2 transition-all relative overflow-hidden group"
              [ngClass]="{
                'border-emerald-500 bg-emerald-50/50 shadow-emerald-100 shadow-md': idx === activeQuestion()?.correctOptionIndex,
                'border-red-500 bg-red-50/50 shadow-red-100 shadow-md': opt.isSelected && idx !== activeQuestion()?.correctOptionIndex,
                'border-gray-100 bg-white hover:border-gray-200 hover:bg-gray-50': !opt.isSelected && idx !== activeQuestion()?.correctOptionIndex
              }">
              
              <!-- Icon Indicator -->
              <div class="w-8 h-8 rounded-xl border-2 flex items-center justify-center flex-shrink-0 text-sm font-bold shadow-sm transition-transform group-hover:scale-110"
                   [ngClass]="{
                     'border-emerald-500 bg-emerald-500 text-white': idx === activeQuestion()?.correctOptionIndex,
                     'border-red-500 bg-red-500 text-white': opt.isSelected && idx !== activeQuestion()?.correctOptionIndex,
                     'border-gray-200 bg-gray-50 text-gray-400': !opt.isSelected && idx !== activeQuestion()?.correctOptionIndex
                   }">
                   @if (idx === activeQuestion()?.correctOptionIndex) { ‚úì }
                   @else if (opt.isSelected) { ‚úï }
                   @else { {{['A','B','C','D'][idx]}} }
              </div>

              <span class="font-bold text-base" 
                    [ngClass]="{
                      'text-emerald-900': idx === activeQuestion()?.correctOptionIndex,
                      'text-red-900': opt.isSelected && idx !== activeQuestion()?.correctOptionIndex,
                      'text-gray-500': !opt.isSelected && idx !== activeQuestion()?.correctOptionIndex
                    }">
                {{ opt.text }}
              </span>

            </div>
         }
       </div>

       <div class="flex justify-between mt-10 pt-6 border-t border-gray-100">
         <button class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-indigo-600 disabled:opacity-30 transition-colors"
                 [disabled]="activeQuestionIndex() === 0"
                 (click)="goToPreviousQuestion()">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Prev
         </button>
         <button class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-indigo-600 disabled:opacity-30 transition-colors"
                 [disabled]="activeQuestionIndex() === questions().length - 1"
                 (click)="goToNextQuestion()">
            Next
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
         </button>
       </div>

    </div>
  </div>
}
