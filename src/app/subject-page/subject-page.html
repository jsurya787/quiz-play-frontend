<div class="relative overflow-hidden">

  <!-- BACKGROUND DECOR -->
  <div class="absolute inset-0 -z-10 bg-gradient-to-br from-indigo-50 via-white to-indigo-100"></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">

    <!-- ================= SUBJECT HERO ================= -->
    @if (!loading()) {
    <div class="mb-10 p-6 sm:p-8 rounded-2xl
               bg-white/70 backdrop-blur-md
               shadow-sm animate-fade-in">

      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">
            {{ subject()?.name }}
          </h1>

          <p class="mt-2 text-gray-600 max-w-2xl">
            {{ subject()?.description }}
          </p>
        </div>

        @if (isAdmin()) {
        <button class="px-3 py-1.5 rounded-lg border
                     text-gray-600 text-sm
                     hover:bg-gray-100 transition" (click)="openEditSubject()">
          ‚úèÔ∏è Edit
        </button>
        }
      </div>

      <!-- PRIMARY ACTIONS -->
      <div class="mt-6 flex flex-col sm:flex-row gap-4">
        <button class="cursor-pointer px-7 py-3 rounded-xl
                   bg-indigo-600 text-white font-semibold
                   shadow-md hover:shadow-lg
                   hover:bg-indigo-700
                   transition transform hover:-translate-y-0.5" [disabled]="!quizzes().length"
          [routerLink]="quizzes().length ? ['/quiz-player-page', quizzes()[0]._id] : null">
          ‚ñ∂ Start Full Mock Test
        </button>

        <button class="cursor-pointer px-7 py-3 rounded-xl
                   border border-indigo-600
                   text-indigo-600 font-semibold
                   hover:bg-indigo-50
                   transition" [routerLink]="['/create-quiz-page']">
          + Create Custom Quiz
        </button>
      </div>
    </div>
    }

    <!-- ================= QUIZZES (RESTORED) ================= -->
    @if (quizzes().length) {
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-14">

      <h2 class="text-xl font-bold mb-6">
        üìò Available Quizzes
      </h2>

      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        @for (quiz of quizzes(); track quiz._id) {
        <div class="relative p-6 rounded-2xl
                   bg-white/80 backdrop-blur
                   border shadow-sm
                   hover:shadow-lg transition">

          @if (isAdmin()) {
          <div class="absolute top-3 right-3 flex gap-2 text-sm">
            <button class="text-red-600" (click)="$event.stopPropagation();confirmDelete('quiz', quiz._id)">
              üóë
            </button>
          </div>
          }

          <h3 class="text-lg font-semibold text-gray-900">
            {{ quiz.title }}
          </h3>

          <p class="text-sm text-gray-600 mt-1">
            {{ quiz.questions?.length || 0 }} Questions ‚Ä¢
            {{ quiz.timeLimit }} Minutes
          </p>

          <div class="mt-4 flex justify-between items-center">
            <span class="text-xs text-gray-500">
              Difficulty: {{ quiz.difficulty | titlecase }}
            </span>

            <a class="text-indigo-600 font-semibold hover:underline" [routerLink]="['/quiz-player-page', quiz._id]">
              Start ‚Üí
            </a>
          </div>
        </div>
        }
      </div>
    </section>
    }

    <!-- ================= HOT TOPICS ================= -->

    <section class="mb-14">

      <div class="flex justify-between items-center mb-5">
        <h2 class="text-xl font-bold">üî• Hot Topics</h2>

        @if (isAdmin()) {
        <button class="cursor-pointer px-4 py-2 rounded-lg
                     bg-indigo-600 text-white text-sm
                     hover:bg-indigo-700 transition" (click)="openHotTopic()">
          ‚ûï Add
        </button>
        }
      </div>
      @if (subjectInfo()?.hotTopics?.length) {

      <div class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
        @for (topic of subjectInfo().hotTopics; track topic._id) {
        <div class="relative p-5 rounded-2xl
                     bg-white/80 backdrop-blur
                     border border-gray-100
                     hover:border-indigo-300
                     hover:bg-indigo-50
                     transition transform hover:-translate-y-0.5">
          <!-- [routerLink]="['/chapter-page/' + topic._id]" -->

          @if (isAdmin()) {
          <div class="absolute top-3 right-3 flex gap-2">
            <button class="text-xs" (click)="$event.stopPropagation();openHotTopic(topic)">
              ‚úèÔ∏è
            </button>
            <button class="text-xs text-red-600"
              (click)="$event.stopPropagation();confirmDelete('hotTopic', topic._id)">
              üóë
            </button>
          </div>
          }

          <h3 class="font-semibold text-gray-900">
            {{ topic.title }}
          </h3>

          <p class="text-sm text-gray-600 mt-1">
            {{ topic.description }}
          </p>
        </div>
        }
      </div>
      }
    </section>

    <!-- ================= CHAPTER PRACTICE ================= -->
    <section>

      <div class="flex justify-between items-center mb-5">
        <h2 class="text-xl font-bold">
          üß† Practice by Chapter
        </h2>

        @if (isAdmin()) {
        <button class="cursor-pointer px-4 py-2 rounded-lg
                     bg-indigo-600 text-white text-sm
                     hover:bg-indigo-700 transition" (click)="openChapter()">
          ‚ûï Add Chapter
        </button>
        }
      </div>
      @if (chapters().length) {
      <div class="grid gap-5 sm:grid-cols-2 lg:grid-cols-4">
        @for (chapter of chapters(); track chapter._id) {
        <div class="relative cursor-pointer p-5 rounded-2xl
                     bg-white/70 backdrop-blur
                     border border-gray-100
                     hover:border-indigo-300
                     hover:bg-indigo-50
                     transition transform hover:-translate-y-0.5" [routerLink]="['/chapter-page/' + chapter._id]">

          @if (isAdmin()) {
          <div class="absolute top-3 right-3 flex gap-2">
            <button class="text-xs" (click)="$event.stopPropagation();openChapter(chapter)">
              ‚úèÔ∏è
            </button>
            <button class="text-xs text-red-600"
              (click)="$event.stopPropagation();confirmDelete('chapter', chapter._id)">
              üóë
            </button>
          </div>
          }

          <h3 class="font-semibold text-gray-900">
            {{ chapter.name }}
          </h3>

          <p class="text-sm text-gray-600 mt-1">
            {{ chapter.description }}
          </p>
        </div>
        }
      </div>
      }
    </section>

  </div>
</div>

<!-- ================= UNIVERSAL POPUP ================= -->
@if (showPopup()) {
<div class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">

  <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-xl animate-fade-in">

    <h3 class="text-lg font-bold mb-4">
      {{ popupTitle() }}
    </h3>

    <!-- SUBJECT -->
    @if (popupType() === 'subject') {
    <input class="input w-full mb-3" placeholder="Subject Name" [(ngModel)]="formModel().name">

    <textarea class="input w-full" placeholder="Description" [(ngModel)]="formModel().description"></textarea>
    }

    <!-- HOT TOPIC -->
    @if (popupType() === 'hotTopic') {

    <input class="input w-full mb-3" placeholder="Title" [(ngModel)]="formModel().title" />

    <textarea class="input w-full mb-3" placeholder="Description" [(ngModel)]="formModel().description">
  </textarea>

    <!-- PRIORITY DROPDOWN -->
    <label class="block text-sm font-medium text-gray-700 mb-1">
      Priority
    </label>

    <select class="input w-full" [(ngModel)]="formModel().priority">

      @for (p of [1,2,3,4,5]; track p) {
      <option [ngValue]="p">
        Priority {{ p }}
      </option>
      }
    </select>
    }


    <!-- CHAPTER -->
    @if (popupType() === 'chapter') {

    <input class="input w-full mb-3" placeholder="Chapter Name" [(ngModel)]="formModel().name" />

    <textarea class="input w-full mb-3" placeholder="Description" [(ngModel)]="formModel().description">
        </textarea>

    <!-- ORDER -->
    <label class="block text-sm font-medium text-gray-700 mb-1">
      Chapter Order
    </label>

    <select class="input w-full mb-3" [(ngModel)]="formModel().order">

      @for (o of [1,2,3,4,5,6,7,8,9,10]; track o) {
      <option [ngValue]="o">Order {{ o }}</option>
      }
    </select>

    <!-- ACTIVE -->
    <label class="flex items-center gap-2 text-sm">
      <input type="checkbox" [(ngModel)]="formModel().isActive" />
      Active
    </label>
    }


    <!-- DELETE CONFIRM -->
    @if (popupType() === 'confirmDelete') {
    <p class="text-gray-600">
      Are you sure you want to delete this item?
    </p>
    }

    <div class="mt-6 flex justify-end gap-3">
      <button class="px-4 py-2 border rounded-lg" (click)="closePopup()">
        Cancel
      </button>

      @if (popupType() === 'confirmDelete') {
      <button class="px-4 py-2 bg-red-600 text-white rounded-lg" (click)="performDelete()">
        Delete
      </button>
      } @else {
      <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg" (click)="saveForm()">
        Save
      </button>
      }
    </div>

  </div>
</div>
}